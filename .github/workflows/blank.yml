name: ðŸš€ Check Vulnerability

on:
  push:
  pull_request:
      branches: 
      - '!dependabot/**'
jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Check vulnerability
    steps:
      - run: env
      
      - name: Check Dependabot Alerts
        id: alerts
        run: |          
         script='query {
           repository( owner: \"OWNER\", name: \"REPO\" ) {
             vulnerabilityAlerts(first: 10) {
               nodes {
                 securityAdvisory {
                   severity
                 }
                 state
               }
             }    
           }
         }' 
         
         export REPO=$(echo $GITHUB_REPOSITORY | cut -f2 -d "/")
         
         script=$(echo $script | sed "s|OWNER|${GITHUB_REPOSITORY_OWNER}|g")
         script=$(echo $script | sed "s|REPO|${REPO}|g")
          
         echo $script 
         
         count=$(curl -s -H "Authorization: bearer ${{ secrets.GH_PAT }}" \
                         -H 'Content-Type: application/json' \
                         -X POST https://api.github.com/graphql \
                         --data "{ \"query\": \"$script\"}" | jq .data.repository.vulnerabilityAlerts.nodes[] | \
                         jq 'select((.securityAdvisory.severity == "CRITICAL") and .state == "OPEN" )' | \
                         jq .securityAdvisory.severity | wc -l )
                  
          echo ::set-output name=critical_alerts::$count 
      - name: Error Exit
        if: steps.alerts.outputs.critical_alerts > 0
        continue-on-error: true
        run: |          
          script='query {
            repository(owner: \"$OWNER\", name: \"REPOSITOR\") {
              vulnerabilityAlerts(first: 10) {
                nodes {
                  securityVulnerability {
                    package {
                      name
                    }
                    advisory {
                      severity
                      permalink
                    }  
                  }
                }
              }    
            }
          }'
          
          script=$(echo $script / sed "s/OWNER/${GITHUB_REPOSITORY_OWNER}/g")
          script=$(echo $script / sed "s/REPO/${GITHUB_REPOSITORY}/g")
          
          curl -s -H "Authorization: bearer ${{ secrets.GH_PAT }}" \
                  -H 'Content-Type: application/json' \
                  -X POST https://api.github.com/graphql \
                  --data "{ \"query\": \"$script\"}" | jq .data.repository.vulnerabilityAlerts.nodes[] | jq .securityVulnerability | \
                  jq 'select(.advisory.severity == "CRITICAL")' > result.json
        
          echo ::set-output name=alerts_list::$(cat result.json | jq .advisory.permalink -r )
          
      - name: Comment PR
        if: steps.alerts.outputs.critical_alerts > 0
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
               This PR has secutiry alerts. Pls fix it before merge:
               ${{ steps.alerts-list.outputs.alerts_list }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Check
        if: steps.alerts.outputs.critical_alerts > 0
        run: exit 1
