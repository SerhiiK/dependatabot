name: ðŸš€ Check Vulnerability

on:
  pull_request:
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Check vulnerability
    steps:
      - name: Check Dependabot Alerts
        id: alerts-list
        run: |          
          script='query {
            repository(owner: \"OWNER\", name: \"REPO\") {
              vulnerabilityAlerts(first: 10) {
                nodes {
                  securityVulnerability {
                    package {
                      name
                    }
                    advisory {
                      severity
                      permalink
                    }  
                  }
                }
              }    
            }
          }'
          
          export REPO=$(echo $GITHUB_REPOSITORY | cut -f2 -d "/")
           
          script=$(echo $script | sed "s|OWNER|${GITHUB_REPOSITORY_OWNER}|g")
          script=$(echo $script | sed "s|REPO|${REPO}|g")
          
          curl -s -H "Authorization: bearer ${{ secrets.GH_PAT }}" \
                  -H 'Content-Type: application/json' \
                  -X POST https://api.github.com/graphql \
                  --data "{ \"query\": \"$script\"}" | jq .data.repository.vulnerabilityAlerts.nodes[] | jq .securityVulnerability | \
                  jq 'select(.advisory.severity == "CRITICAL")' > result.json
          
          result=$(cat result.json | jq .advisory.permalink -r)
          echo $result
          
          echo "::set-output name=alerts_list::$result"
          
      - name: Comment PR
        if: steps.alerts.outputs.critical_alerts != ''
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
               This PR has secutiry alerts. Pls fix it before merge:
               ${{ steps.alerts-list.outputs.alerts_list }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Error exit
        if: steps.alerts.outputs.critical_alerts != ''
        run: exit 1
